ifeq ($(PLATFORM),EMBEDDED)
ENDIANNESS = BIG
include ../arch/ARM/ixp42x/module.mk
STRIP ?= $(TOOLS_PATH)/strip

else ifeq ($(PLATFORM), BB_LINUX)
include ../arch/ARM/bb/module.mk

else
STRIP ?= strip
endif

STATIC_LIB = libmercuryapi.a
SHARED_LIB = libmercuryapi.so.1

OBJS += serial_transport_posix.o
OBJS += serial_transport_tcp_posix.o
#OBJS += serial_transport_llrp.o
OBJS += tmr_strerror.o
OBJS += tmr_param.o
OBJS += hex_bytes.o
OBJS += tm_reader.o
OBJS += tm_reader_async.o
OBJS += serial_reader.o
OBJS += tmr_loadsave_configuration.o
OBJS += serial_reader_l3.o
OBJS += tmr_utils.o

OBJS += osdep_posix.o

HEADERS += serial_reader_imp.h
HEADERS += tm_config.h
HEADERS += tm_reader.h
HEADERS += tmr_filter.h
HEADERS += tmr_gen2.h
HEADERS += tmr_gpio.h
HEADERS += tmr_ipx.h
HEADERS += tmr_iso180006b.h
HEADERS += tmr_params.h
HEADERS += tmr_read_plan.h
HEADERS += tmr_region.h
HEADERS += tmr_serial_reader.h
HEADERS += tmr_serial_transport.h
HEADERS += tmr_status.h
HEADERS += tmr_tag_auth.h
HEADERS += tmr_tag_data.h
HEADERS += tmr_tag_lock_action.h
HEADERS += tmr_tag_protocol.h
HEADERS += tmr_tagop.h
HEADERS += tmr_types.h
HEADERS += tmr_utils.h

DBG ?= -g
CWARN = -Werror
# Add -Wextra to chase down warnings that might appear on build server, but not dev machines
#CWARN += -Wextra

CFLAGS += -D TMR_ENABLE_SERIAL_READER_ONLY=1
CFLAGS += -I. $(DBG) $(CWARN)

# Position-independent code required for shared libraries
CFLAGS += -fPIC



all: $(STATIC_LIB) $(SHARED_LIB) $(PROGS)

$(OBJS):

$(SHARED_LIB): $(OBJS)
	$(CC) $(CFLAGS) -shared -Wl,-rpath,/tm/lib,-soname,libmercuryapi.so.1 -o $@ $^ $(OPTOBJS) -lpthread
$(STATIC_LIB): $(OBJS)
	ar -rc $@ $^ $(OPTOBJS)

LIB = $(STATIC_LIB)
ifdef SHARED
  ifneq (0,$(SHARED))
    LIB = $(SHARED_LIB)
  endif
endif

.PHONY: clean
clean:
	rm -f $(STATIC_LIB) $(SHARED_LIB) $(PROGS) *.o ../samples/*.o core tests/*.output
	rm -fr lib/LTK

.PHONY: test
TESTSCRIPTS ?=
test: demo
	tests/runtests.sh $(TESTSCRIPTS)

longtest: demo
	while [ 1 ]; do echo Iteration: `date`; make test; done

test-sleeprecovery: demo
	./demo -v $(URI) <tests/test-sleeprecovery.prelim-script
# @todo Turn sleeprecovery into a real script when we know what to put in the key file

# What serial ports exist?
list-linux-ports:
	echo /dev/tty{ACM,USB,S}*

## Measure library size
libsize: $(LIB) $(LIB).stripped
	svn di tm_config.h
	echo DBG: $(DBG)
	ls -l $<*
	echo

%.stripped: %
	cp -p $< $@
	strip $@

## Test of minimum library size
empty.c:
	echo >$@

libempty.a: empty.o
	ar -rc $@ $^

libemptysize: libempty.a libempty.a.stripped
	ls -l $<*
	echo

# For internal use only.  Distribution should already include the following target files.
lib/install_LTKC.sh:
	make -f externals.mk

ifdef EXTRAMKS
include $(EXTRAMKS)
endif
